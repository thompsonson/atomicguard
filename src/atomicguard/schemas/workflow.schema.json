{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "atomicguard/workflow.schema.json",
  "title": "AtomicGuard Workflow Definition",
  "description": "Formal workflow specification aligned with Definition 9 (Workflow Orchestration)",
  "type": "object",
  "required": ["name", "action_pairs"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Human-readable workflow identifier"
    },
    "description": {
      "type": "string",
      "description": "Extended workflow description"
    },
    "specification": {
      "$ref": "#/$defs/SpecificationSource",
      "description": "Ψ - Specification source reference (external to workflow)"
    },
    "constraints": {
      "type": "string",
      "description": "Ω - Global constraints (ambient environment)"
    },
    "model": {
      "type": "string",
      "description": "Default LLM model identifier for generators",
      "default": "qwen2.5-coder:7b"
    },
    "provider": {
      "type": "string",
      "description": "LLM provider identifier for PydanticAI model selection",
      "enum": ["ollama", "huggingface", "openrouter", "openai"],
      "default": "ollama"
    },
    "rmax": {
      "type": "integer",
      "minimum": 1,
      "default": 3,
      "description": "R_max - Maximum retry attempts per action pair (Definition 8)"
    },
    "action_pairs": {
      "type": "object",
      "description": "Map of action_pair_id → ActionPair definition (Definition 6)",
      "additionalProperties": {
        "$ref": "#/$defs/ActionPair"
      }
    }
  },
  "$defs": {
    "SpecificationSource": {
      "oneOf": [
        {
          "type": "string",
          "description": "Inline specification text (for simple cases)"
        },
        {
          "type": "object",
          "description": "External specification reference",
          "required": ["type", "ref"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["file", "folder", "service", "inline"],
              "description": "Specification source type"
            },
            "ref": {
              "type": "string",
              "description": "Reference path or URI (e.g., 'specs/architecture.md', 'jira://PROJ-123')"
            },
            "glob": {
              "type": "string",
              "description": "For folder type: glob pattern to select files (e.g., '**/*.md')"
            }
          }
        }
      ]
    },
    "GuardSpec": {
      "oneOf": [
        {
          "type": "string",
          "description": "Simple guard reference by name"
        },
        {
          "type": "object",
          "description": "Guard with configuration (Extension 08)",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "description": "Guard type identifier"
            },
            "config": {
              "type": "object",
              "description": "Guard-specific configuration",
              "additionalProperties": true
            }
          }
        },
        {
          "$ref": "#/$defs/CompositeGuardSpec",
          "description": "Nested composite guard (Definition 42)"
        }
      ]
    },
    "CompositeGuardSpec": {
      "type": "object",
      "description": "Composite guard specification (Definition 38). Combines multiple guards with composition strategy and aggregation policy.",
      "required": ["guards"],
      "properties": {
        "compose": {
          "type": "string",
          "enum": ["sequential", "parallel"],
          "default": "sequential",
          "description": "Composition strategy: sequential (fail-fast, Definition 39) or parallel (concurrent, Definition 40)"
        },
        "policy": {
          "type": "string",
          "enum": ["all_pass", "any_pass", "majority_pass"],
          "default": "all_pass",
          "description": "Aggregation policy (Definition 41): all_pass, any_pass, or majority_pass"
        },
        "guards": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/GuardSpec"
          },
          "description": "Sub-guards to compose"
        }
      }
    },
    "GuardsSpec": {
      "oneOf": [
        {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Simple list of guard names (legacy, sequential fail-fast)"
        },
        {
          "$ref": "#/$defs/CompositeGuardSpec",
          "description": "Full composite guard specification (Extension 08)"
        }
      ]
    },
    "ActionPair": {
      "type": "object",
      "description": "A = ⟨ρ, a_gen, G⟩ - Atomic generation-verification unit (Definition 6). The generator (a_gen) and guard (G) form a coupled transaction: generator produces artifacts, guard validates them.",
      "required": ["guard"],
      "properties": {
        "generator": {
          "type": "string",
          "description": "Generator type identifier (a_gen). Maps to GeneratorInterface implementation via entry points. If omitted, uses workflow-level default generator. Per Remark 5, generators may be autonomous Semantic Agents (e.g., ADDGenerator) that internally orchestrate multiple sub-steps.",
          "pattern": "^[A-Z][a-zA-Z0-9]*Generator$|^[a-z][a-z0-9_]*$"
        },
        "generator_config": {
          "type": "object",
          "description": "Generator-specific configuration parameters (passed to constructor)",
          "additionalProperties": true
        },
        "guard": {
          "type": "string",
          "description": "Guard type identifier (G). Built-in types: syntax, import, type, dynamic_test, human, composite. Custom guards use snake_case identifiers.",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "guards": {
          "$ref": "#/$defs/GuardsSpec",
          "description": "For composite guards: sub-guards specification (Extension 08). Supports simple list or full CompositeGuardSpec."
        },
        "guard_config": {
          "type": "object",
          "description": "Guard-specific configuration parameters (θ)",
          "additionalProperties": true
        },
        "requires": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "ρ - Precondition: action_pair_ids that must be satisfied (⊤) before execution"
        },
        "output_type": {
          "type": "string",
          "description": "Expected artifact type (for structured output parsing)"
        },
        "human_prompt_title": {
          "type": "string",
          "description": "Title for human review guard prompts"
        }
      }
    }
  }
}
