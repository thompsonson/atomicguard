<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Visualization: 067a4d9a...</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/diff.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .header-info {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .header-info span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-SUCCESS { background: #10b981; color: white; }
        .status-IN_PROGRESS { background: #f59e0b; color: white; }
        .status-FAILED { background: #ef4444; color: white; }
        .status-EMPTY { background: #6b7280; color: white; }
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #cy {
            flex: 1;
            background: white;
            border-right: 1px solid #e5e7eb;
        }
        .sidebar {
            width: 450px;
            background: white;
            overflow-y: auto;
            padding: 1rem;
        }
        .sidebar h2 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .no-selection {
            color: #9ca3af;
            font-style: italic;
            text-align: center;
            padding: 2rem;
        }
        .artifact-detail {
            display: none;
        }
        .artifact-detail.active {
            display: block;
        }
        .detail-section {
            margin-bottom: 1.5rem;
        }
        .detail-section h3 {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .collapsible {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            cursor: pointer;
            user-select: none;
        }
        .collapsible-header:hover {
            background: #f3f4f6;
        }
        .collapsible-header h4 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
        }
        .collapsible-header .badge {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: #e5e7eb;
            color: #4b5563;
        }
        .collapsible-header .toggle {
            font-size: 1rem;
            color: #9ca3af;
            transition: transform 0.2s;
        }
        .collapsible.expanded .toggle {
            transform: rotate(180deg);
        }
        .collapsible-content {
            display: none;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background: white;
        }
        .collapsible.expanded .collapsible-content {
            display: block;
        }
        .code-block {
            background: #f6f8fa;
            color: #24292e;
            padding: 1rem;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.82rem;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .code-block code {
            background: transparent;
        }
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .meta-item {
            background: #f9fafb;
            padding: 0.75rem;
            border-radius: 6px;
        }
        .meta-item label {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .meta-item span {
            font-size: 0.9rem;
            color: #111827;
            font-weight: 500;
        }
        .guard-result {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .guard-result.passed {
            background: #d1fae5;
            border: 1px solid #10b981;
        }
        .guard-result.failed {
            background: #fee2e2;
            border: 1px solid #ef4444;
        }
        .guard-result .guard-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .guard-result .guard-feedback {
            font-size: 0.85rem;
            color: #4b5563;
            white-space: pre-wrap;
        }
        .feedback-entry {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .feedback-entry .entry-number {
            font-size: 0.75rem;
            color: #92400e;
            margin-bottom: 0.25rem;
        }
        .feedback-entry .entry-content {
            font-size: 0.85rem;
            white-space: pre-wrap;
        }
        .escalation-feedback {
            background: #fce7f3;
            border: 1px solid #ec4899;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .escalation-feedback .label {
            font-size: 0.75rem;
            color: #9d174d;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        footer {
            background: #1f2937;
            color: #9ca3af;
            padding: 0.5rem 2rem;
            font-size: 0.8rem;
            text-align: center;
        }
        .legend {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .legend-color.accepted { background: #10b981; }
        .legend-color.rejected { background: #ef4444; }
        .legend-color.pending { background: #f59e0b; }
        .legend-color.superseded { background: #6b7280; }
        .legend-color.escalation { background: #ec4899; border: 2px dashed #ec4899; }
        .legend-line {
            width: 24px;
            height: 2px;
            position: relative;
        }
        .legend-line.causal { background: #6366f1; }
        .legend-line.retry { background: #9ca3af; border-top: 2px dashed #9ca3af; height: 0; }
        .legend-line.escalation-retry { background: #ec4899; border-top: 2px dashed #ec4899; height: 0; }
        .run-selector {
            display: none;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 2rem;
            background: #eef2ff;
            border-bottom: 1px solid #c7d2fe;
            flex-wrap: wrap;
        }
        .run-selector-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #4338ca;
        }
        .run-btn {
            padding: 0.3rem 0.75rem;
            border: 1px solid #c7d2fe;
            border-radius: 6px;
            background: white;
            color: #4338ca;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .run-btn:hover {
            background: #e0e7ff;
        }
        .run-btn.active {
            background: #4338ca;
            color: white;
            border-color: #4338ca;
        }
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            #cy {
                min-height: 300px;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
            .sidebar {
                width: 100%;
            }
            .header-info {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .legend {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Workflow Visualization</h1>
            <div class="header-info">
                <span><strong>ID:</strong> 067a4d9a...</span>
                <span class="status-badge status-SUCCESS">SUCCESS</span>
                <span><strong>Steps:</strong> 2</span>
                <span><strong>Artifacts:</strong> 5</span>
                <span><strong>Escalations:</strong> 2</span>
            </div>
        </header>
        <div id="run-selector" class="run-selector">
            <span class="run-selector-label">Execution Run:</span>
            <div id="run-buttons" style="display:flex;gap:0.5rem;flex-wrap:wrap;"></div>
        </div>
        <main>
            <div id="cy"></div>
            <div class="sidebar">
                <h2>Artifact Details</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color accepted"></div>
                        <span>Accepted</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color rejected"></div>
                        <span>Rejected</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color pending"></div>
                        <span>Pending</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color escalation"></div>
                        <span>Escalation</span>
                    </div>
                    <div class="legend-item" id="legend-causal">
                        <div class="legend-line causal"></div>
                        <span>Causal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line retry"></div>
                        <span>Retry</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line escalation-retry"></div>
                        <span>Escalation Retry</span>
                    </div>
                </div>
                <div id="detail-panel">
                    <p class="no-selection">Click on an artifact node to view details</p>
                </div>
            </div>
        </main>
        <footer>
            Generated by AtomicGuard Visualization | 2026-02-13T13:48:52.259630
        </footer>
    </div>

    <script>
        // Embedded data
        const nodes = [
  {
    "data": {
      "id": "artifact_6d1bfe08",
      "label": "spec #1",
      "type": "artifact",
      "status": "accepted",
      "artifact_id": "6d1bfe08-f4c6-4456-821d-24fd43a54a02",
      "attempt_number": 1,
      "step_id": "spec",
      "has_escalation_feedback": false,
      "feedback_count": 0
    }
  },
  {
    "data": {
      "id": "artifact_59712063",
      "label": "spec #2",
      "type": "artifact",
      "status": "accepted",
      "artifact_id": "59712063-6571-495c-87de-cc2b42972976",
      "attempt_number": 2,
      "step_id": "spec",
      "has_escalation_feedback": false,
      "feedback_count": 0
    }
  },
  {
    "data": {
      "id": "artifact_6749bde3",
      "label": "impl #1",
      "type": "artifact",
      "status": "rejected",
      "artifact_id": "6749bde3-e13f-41bf-84fb-b87bb293c510",
      "attempt_number": 1,
      "step_id": "impl",
      "has_escalation_feedback": false,
      "feedback_count": 0
    }
  },
  {
    "data": {
      "id": "artifact_d529b86b",
      "label": "impl #2",
      "type": "artifact",
      "status": "rejected",
      "artifact_id": "d529b86b-7045-4a83-a24c-47b82a20474f",
      "attempt_number": 2,
      "step_id": "impl",
      "has_escalation_feedback": false,
      "feedback_count": 1
    }
  },
  {
    "data": {
      "id": "artifact_bebdc951",
      "label": "impl #3",
      "type": "artifact",
      "status": "accepted",
      "artifact_id": "bebdc951-df34-403c-932e-4c35c0c5ba24",
      "attempt_number": 3,
      "step_id": "impl",
      "has_escalation_feedback": false,
      "feedback_count": 2
    }
  }
];
        const edges = [
  {
    "data": {
      "id": "retry_59712063",
      "source": "artifact_6d1bfe08",
      "target": "artifact_59712063",
      "type": "escalation_retry"
    }
  },
  {
    "data": {
      "id": "retry_d529b86b",
      "source": "artifact_6749bde3",
      "target": "artifact_d529b86b",
      "type": "retry"
    }
  },
  {
    "data": {
      "id": "retry_bebdc951",
      "source": "artifact_d529b86b",
      "target": "artifact_bebdc951",
      "type": "escalation_retry"
    }
  }
];
        const artifacts = {
  "6d1bfe08-f4c6-4456-821d-24fd43a54a02": {
    "artifact_id": "6d1bfe08-f4c6-4456-821d-24fd43a54a02",
    "action_pair_id": "spec",
    "workflow_id": "067a4d9a-2774-4ace-b855-59e73989bf7f",
    "content": "## Specification: process_input(value)\n\nThe function should:\n1. Accept a string value as input\n2. Convert the value to uppercase\n3. Return the processed string\n\nExample:\n  process_input(\"hello\") -> \"HELLO\"\n",
    "status": "accepted",
    "attempt_number": 1,
    "created_at": "2026-02-13T13:48:52.243905",
    "previous_attempt_id": null,
    "guard_result": {
      "passed": true,
      "feedback": "",
      "fatal": false,
      "guard_name": "AlwaysPassGuard",
      "sub_results": []
    },
    "context": {
      "specification": "",
      "constraints": "",
      "feedback_history": [],
      "dependency_artifacts": [],
      "escalation_feedback": []
    }
  },
  "59712063-6571-495c-87de-cc2b42972976": {
    "artifact_id": "59712063-6571-495c-87de-cc2b42972976",
    "action_pair_id": "spec",
    "workflow_id": "067a4d9a-2774-4ace-b855-59e73989bf7f",
    "content": "## Specification: process_input(value)\n\nThe function should:\n1. Accept a string value as input (may be None)\n2. Handle EDGE CASE: If value is None, return empty string\n3. Handle EDGE CASE: If value is not a string, convert to string first\n4. Convert the value to uppercase\n5. Return the processed string\n\nExamples:\n  process_input(\"hello\") -> \"HELLO\"\n  process_input(None) -> \"\"\n  process_input(123) -> \"123\"\n",
    "status": "accepted",
    "attempt_number": 2,
    "created_at": "2026-02-13T13:48:52.244312",
    "previous_attempt_id": null,
    "guard_result": {
      "passed": true,
      "feedback": "",
      "fatal": false,
      "guard_name": "AlwaysPassGuard",
      "sub_results": []
    },
    "context": {
      "specification": "",
      "constraints": "",
      "feedback_history": [],
      "dependency_artifacts": [],
      "escalation_feedback": []
    }
  },
  "6749bde3-e13f-41bf-84fb-b87bb293c510": {
    "artifact_id": "6749bde3-e13f-41bf-84fb-b87bb293c510",
    "action_pair_id": "impl",
    "workflow_id": "067a4d9a-2774-4ace-b855-59e73989bf7f",
    "content": "def process_input(value):\n    return value.upper()\n",
    "status": "rejected",
    "attempt_number": 1,
    "created_at": "2026-02-13T13:48:52.243962",
    "previous_attempt_id": null,
    "guard_result": {
      "passed": false,
      "feedback": "TypeError: cannot handle None input - missing null check in implementation",
      "fatal": false,
      "guard_name": "RequiresEdgeCaseGuard",
      "sub_results": []
    },
    "context": {
      "specification": "",
      "constraints": "",
      "feedback_history": [],
      "dependency_artifacts": [],
      "escalation_feedback": []
    }
  },
  "d529b86b-7045-4a83-a24c-47b82a20474f": {
    "artifact_id": "d529b86b-7045-4a83-a24c-47b82a20474f",
    "action_pair_id": "impl",
    "workflow_id": "067a4d9a-2774-4ace-b855-59e73989bf7f",
    "content": "def process_input(value):\n    result = value.upper()\n    return result\n",
    "status": "rejected",
    "attempt_number": 2,
    "created_at": "2026-02-13T13:48:52.244064",
    "previous_attempt_id": "6749bde3-e13f-41bf-84fb-b87bb293c510",
    "guard_result": {
      "passed": false,
      "feedback": "TypeError: cannot handle None input - missing null check in implementation",
      "fatal": false,
      "guard_name": "RequiresEdgeCaseGuard",
      "sub_results": []
    },
    "context": {
      "specification": "",
      "constraints": "",
      "feedback_history": [
        {
          "artifact_id": "6749bde3-e13f-41bf-84fb-b87bb293c510",
          "feedback": "TypeError: cannot handle None input - missing null check in implementation"
        }
      ],
      "dependency_artifacts": [],
      "escalation_feedback": []
    }
  },
  "bebdc951-df34-403c-932e-4c35c0c5ba24": {
    "artifact_id": "bebdc951-df34-403c-932e-4c35c0c5ba24",
    "action_pair_id": "impl",
    "workflow_id": "067a4d9a-2774-4ace-b855-59e73989bf7f",
    "content": "def process_input(value):\n    # Handle edge case: None input\n    if value is None:\n        return \"\"\n    # Handle edge case: non-string input\n    if not isinstance(value, str):\n        value = str(value)\n    return value.upper()\n",
    "status": "accepted",
    "attempt_number": 3,
    "created_at": "2026-02-13T13:48:52.244345",
    "previous_attempt_id": null,
    "guard_result": {
      "passed": true,
      "feedback": "Implementation correctly handles edge cases.",
      "fatal": false,
      "guard_name": "RequiresEdgeCaseGuard",
      "sub_results": []
    },
    "context": {
      "specification": "",
      "constraints": "",
      "feedback_history": [
        {
          "artifact_id": "6749bde3-e13f-41bf-84fb-b87bb293c510",
          "feedback": "TypeError: cannot handle None input - missing null check in implementation"
        },
        {
          "artifact_id": "d529b86b-7045-4a83-a24c-47b82a20474f",
          "feedback": "TypeError: cannot handle None input - missing null check in implementation"
        }
      ],
      "dependency_artifacts": [],
      "escalation_feedback": []
    }
  }
};
        const runs = [
  {
    "label": "Initial",
    "node_ids": [
      "artifact_6749bde3",
      "artifact_6d1bfe08",
      "artifact_d529b86b"
    ],
    "edge_ids": [
      "retry_d529b86b"
    ]
  },
  {
    "label": "Esc. 1",
    "node_ids": [
      "artifact_59712063",
      "artifact_bebdc951"
    ],
    "edge_ids": []
  }
];

        // Colour palette for escalation runs (causal edges).
        const RUN_COLORS = ['#6366f1', '#f97316', '#06b6d4', '#84cc16', '#ec4899'];

        // Initialize Cytoscape
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: {
                nodes: nodes,
                edges: edges
            },
            style: [
                // Artifact nodes (flat — no compound grouping)
                {
                    selector: 'node[type="artifact"]',
                    style: {
                        'shape': 'round-rectangle',
                        'width': 'label',
                        'height': 30,
                        'padding': '12px',
                        'background-color': '#9ca3af',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': '11px',
                        'font-weight': 'bold',
                        'color': 'white'
                    }
                },
                {
                    selector: 'node[type="artifact"][status="accepted"]',
                    style: {
                        'background-color': '#10b981'
                    }
                },
                {
                    selector: 'node[type="artifact"][status="rejected"]',
                    style: {
                        'background-color': '#ef4444'
                    }
                },
                {
                    selector: 'node[type="artifact"][status="pending"]',
                    style: {
                        'background-color': '#f59e0b'
                    }
                },
                {
                    selector: 'node[type="artifact"][status="superseded"]',
                    style: {
                        'background-color': '#6b7280'
                    }
                },
                {
                    selector: 'node[type="artifact"][has_escalation_feedback]',
                    style: {
                        'border-width': 3,
                        'border-color': '#ec4899',
                        'border-style': 'dashed'
                    }
                },
                // Causal chain edges — coloured by escalation run
                {
                    selector: 'edge[type="causal"]',
                    style: {
                        'width': 3,
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'line-color': 'data(color)',
                        'target-arrow-color': 'data(color)'
                    }
                },
                // Retry edges
                {
                    selector: 'edge[type="retry"]',
                    style: {
                        'width': 2,
                        'line-color': '#9ca3af',
                        'line-style': 'dashed',
                        'target-arrow-color': '#9ca3af',
                        'target-arrow-shape': 'chevron',
                        'curve-style': 'bezier'
                    }
                },
                // Escalation retry edges
                {
                    selector: 'edge[type="escalation_retry"]',
                    style: {
                        'width': 2,
                        'line-color': '#ec4899',
                        'line-style': 'dashed',
                        'target-arrow-color': '#ec4899',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                },
                // Selection
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 4,
                        'border-color': '#3b82f6'
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 50,
                rankSep: 100,
                padding: 30
            }
        });

        // Handle node clicks
        cy.on('tap', 'node[type="artifact"]', function(evt) {
            const node = evt.target;
            const artifactId = node.data('artifact_id');
            showArtifactDetail(artifactId);
        });

        function showArtifactDetail(artifactId) {
            const artifact = artifacts[artifactId];
            if (!artifact) return;

            const panel = document.getElementById('detail-panel');

            // Build dependency artifacts HTML
            let depsHtml = '';
            if (artifact.context.dependency_artifacts && artifact.context.dependency_artifacts.length > 0) {
                depsHtml = artifact.context.dependency_artifacts.map(dep => `
                    <div style="padding:0.4rem 0.6rem;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:4px;margin-bottom:0.4rem;font-size:0.82rem;">
                        <strong>${escapeHtml(dep.action_pair_id)}</strong>
                        <span style="color:#6b7280;margin-left:0.5rem;">${dep.artifact_id.substring(0,8)}...</span>
                    </div>
                `).join('');
            } else {
                depsHtml = '<p style="color: #9ca3af; font-style: italic;">No dependencies</p>';
            }

            // Build feedback history HTML
            let feedbackHtml = '';
            if (artifact.context.feedback_history && artifact.context.feedback_history.length > 0) {
                feedbackHtml = artifact.context.feedback_history.map((entry, i) => `
                    <div class="feedback-entry">
                        <div class="entry-number">Attempt ${i + 1}</div>
                        <div class="entry-content">${escapeHtml(entry.feedback)}</div>
                    </div>
                `).join('');
            } else {
                feedbackHtml = '<p style="color: #9ca3af; font-style: italic;">No previous feedback</p>';
            }

            // Build escalation feedback HTML
            let escalationHtml = '';
            if (artifact.context.escalation_feedback && artifact.context.escalation_feedback.length > 0) {
                escalationHtml = artifact.context.escalation_feedback.map((fb, i) => `
                    <div class="escalation-feedback">
                        <div class="label">Escalation ${i + 1}</div>
                        <div>${escapeHtml(fb)}</div>
                    </div>
                `).join('');
            } else {
                escalationHtml = '<p style="color: #9ca3af; font-style: italic;">No escalation feedback</p>';
            }

            // Build guard result HTML
            let guardHtml = '';
            if (artifact.guard_result) {
                const gr = artifact.guard_result;
                guardHtml = `
                    <div class="guard-result ${gr.passed ? 'passed' : 'failed'}">
                        <div class="guard-name">${gr.guard_name || 'Guard'}: ${gr.passed ? 'PASSED' : 'FAILED'}</div>
                        ${gr.feedback ? `<div class="guard-feedback">${escapeHtml(gr.feedback)}</div>` : ''}
                    </div>
                `;
                if (gr.sub_results && gr.sub_results.length > 0) {
                    guardHtml += gr.sub_results.map(sr => `
                        <div class="guard-result ${sr.passed ? 'passed' : 'failed'}" style="margin-left: 1rem;">
                            <div class="guard-name">${sr.guard_name}: ${sr.passed ? 'PASSED' : 'FAILED'}</div>
                            ${sr.feedback ? `<div class="guard-feedback">${escapeHtml(sr.feedback)}</div>` : ''}
                        </div>
                    `).join('');
                }
            } else {
                guardHtml = '<p style="color: #9ca3af; font-style: italic;">No guard result (pending)</p>';
            }

            // Detect content language for syntax highlighting
            let langClass = '';
            if (artifact.content) {
                const trimmed = artifact.content.trimStart();
                if (trimmed.startsWith('{') || trimmed.startsWith('[')) langClass = 'language-json';
                else if (trimmed.startsWith('diff ') || trimmed.startsWith('---') || trimmed.startsWith('@@')) langClass = 'language-diff';
                else langClass = 'language-python';
            }

            panel.innerHTML = `
                <div class="artifact-detail active">
                    <div class="detail-section">
                        <div class="meta-grid">
                            <div class="meta-item">
                                <label>Step</label>
                                <span>${artifact.action_pair_id}</span>
                            </div>
                            <div class="meta-item">
                                <label>Attempt</label>
                                <span>#${artifact.attempt_number}</span>
                            </div>
                            <div class="meta-item">
                                <label>Status</label>
                                <span style="text-transform: uppercase;">${artifact.status}</span>
                            </div>
                            <div class="meta-item">
                                <label>Created</label>
                                <span>${new Date(artifact.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div style="margin-top:0.75rem;padding:0.5rem 0.75rem;background:#f9fafb;border-radius:6px;font-size:0.78rem;color:#6b7280;word-break:break-all;">
                            <strong>Artifact ID:</strong> ${artifact.artifact_id}
                            ${artifact.previous_attempt_id ? '<br><strong>Previous:</strong> ' + artifact.previous_attempt_id : ''}
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible expanded">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Content</h4>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                <pre class="code-block"><code class="${langClass}">${escapeHtml(artifact.content)}</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible expanded">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Guard Result</h4>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                ${guardHtml}
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Dependency Artifacts</h4>
                                <span class="badge">${artifact.context.dependency_artifacts ? artifact.context.dependency_artifacts.length : 0}</span>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                ${depsHtml}
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Specification</h4>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                <pre class="code-block" style="max-height:250px;">${escapeHtml(artifact.context.specification || '')}</pre>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Constraints</h4>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                <pre class="code-block" style="max-height:250px;">${escapeHtml(artifact.context.constraints || '')}</pre>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Feedback History</h4>
                                <span class="badge">${artifact.context.feedback_history ? artifact.context.feedback_history.length : 0} entries</span>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                ${feedbackHtml}
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <h4>Escalation Feedback</h4>
                                <span class="badge">${artifact.context.escalation_feedback ? artifact.context.escalation_feedback.length : 0} entries</span>
                                <span class="toggle">&#9660;</span>
                            </div>
                            <div class="collapsible-content">
                                ${escalationHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Highlight code blocks with language class
            panel.querySelectorAll('pre code[class]').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('expanded');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ── Run selector ──────────────────────────────────────────
        (function initRunSelector() {
            if (runs.length <= 1) return;  // nothing to toggle

            const container = document.getElementById('run-selector');
            const btnContainer = document.getElementById('run-buttons');
            container.style.display = 'flex';

            // "All" button
            const allBtn = document.createElement('button');
            allBtn.className = 'run-btn active';
            allBtn.textContent = 'All';
            allBtn.addEventListener('click', () => selectRun(-1));
            btnContainer.appendChild(allBtn);

            // One button per run — coloured to match causal edges
            runs.forEach((run, idx) => {
                const color = RUN_COLORS[idx] || RUN_COLORS[0];
                const btn = document.createElement('button');
                btn.className = 'run-btn';
                btn.textContent = run.label;
                btn.style.borderLeft = `4px solid ${color}`;
                btn.addEventListener('click', () => selectRun(idx));
                btnContainer.appendChild(btn);
            });

            // Replace single "Causal" legend entry with per-run colour entries
            const legendCausal = document.getElementById('legend-causal');
            if (legendCausal && runs.length > 1) {
                let html = '';
                runs.forEach((run, idx) => {
                    const color = RUN_COLORS[idx] || RUN_COLORS[0];
                    html += `<div class="legend-item"><div class="legend-line" style="background:${color}"></div><span>${run.label}</span></div>`;
                });
                legendCausal.outerHTML = html;
            }

            function selectRun(runIdx) {
                // Update active button
                btnContainer.querySelectorAll('.run-btn').forEach((b, i) => {
                    b.classList.toggle('active', i === runIdx + 1);
                });

                if (runIdx === -1) {
                    // Reset all to full opacity
                    cy.batch(() => {
                        cy.elements().style('opacity', 1);
                    });
                    return;
                }

                const run = runs[runIdx];
                const nodeSet = new Set(run.node_ids);
                const edgeSet = new Set(run.edge_ids);

                cy.batch(() => {
                    cy.nodes().forEach(n => {
                        n.style('opacity', nodeSet.has(n.id()) ? 1 : 0.12);
                    });
                    cy.edges().forEach(e => {
                        e.style('opacity', edgeSet.has(e.id()) ? 1 : 0.06);
                    });
                });
            }
        })();
    </script>
</body>
</html>
